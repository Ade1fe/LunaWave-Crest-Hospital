import React, { useEffect, useState } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import MainLayout from '../../Layout/MainLayout';
import { collection, getDocs } from 'firebase/firestore';
import { db } from '../../firebase'; 
import { Box, Text, Spinner, List, ListItem, Image, Button, Input, InputGroup, Avatar } from '@chakra-ui/react';
import { AdvertComp } from '..';

interface Doctor {
  specialization: string;
  id: string;
  name: string;
  workLocation: string;
  uid: string;
}

interface DoctorWithImageUrl extends Doctor {
  imageUrl?: string;
}

const SearchDoctors: React.FC = () => {
  const location = useLocation();
  const [doctors, setDoctors] = useState<DoctorWithImageUrl[]>([]);
  const [loading, setLoading] = useState<boolean>(true);
  const [userImages, setUserImages] = useState<{ uid: string; imageUrl: string }[]>([]); // State for user images
  const queryParam = new URLSearchParams(location.search).get('query');
  const [searchQuery, setSearchQuery] = useState('');
  const navigate = useNavigate();
  const [currentPage, setCurrentPage] = useState<number>(1);
  const doctorsPerPage = 1; // Number of doctors to display per page

  // Fetch user images separately
  useEffect(() => {
    const fetchUserImages = async () => {
      try {
        const q = collection(db, 'users');
        const querySnapshot = await getDocs(q);
        const userImagesList = querySnapshot.docs.map(doc => ({
          uid: doc.id,
          imageUrl: doc.data().imageUrl || '', // Ensure imageUrl is defined
        }));
        setUserImages(userImagesList);
      } catch (error) {
        console.error('Error fetching user images:', error);
      }
    };

    fetchUserImages();
  }, []);

  // Fetch doctors and merge with user images
  useEffect(() => {
    const fetchDoctors = async () => {
      setLoading(true);
      try {
        const q = collection(db, 'doctors');
        const querySnapshot = await getDocs(q);
        const doctorsList = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) as Doctor[];

        // Merge doctors with user images
        const updatedDoctorsList = doctorsList.map(doctor => {
          const userImage = userImages.find(user => user.uid === doctor.uid);
          return { ...doctor, imageUrl: userImage?.imageUrl };
        });

        // Filter doctors based on case-insensitive search
        const filteredDoctors = updatedDoctorsList.filter(doctor =>
          doctor.name.toLowerCase().includes(queryParam?.toLowerCase() ?? '')
        );

        setDoctors(filteredDoctors);
      } catch (error) {
        console.error('Error fetching doctors:', error);
      }
      setLoading(false);
    };

    fetchDoctors();
  }, [queryParam, userImages]);

  const makeAnAppointment = (doctorId: string) => {
    navigate(`/requestappointment?query=${encodeURIComponent(doctorId)}`);
  };

  // Pagination Logic
  const indexOfLastDoctor = currentPage * doctorsPerPage;
  const indexOfFirstDoctor = indexOfLastDoctor - doctorsPerPage;
  const currentDoctors = doctors.slice(indexOfFirstDoctor, indexOfLastDoctor);
  const totalPages = Math.ceil(doctors.length / doctorsPerPage);

  const handleNextPage = () => {
    setCurrentPage(prevPage => prevPage + 1);
  };

  const handlePrevPage = () => {
    setCurrentPage(prevPage => prevPage - 1);
  };

  const goToPage = (page: number) => {
    setCurrentPage(page);
  };

  return (
    <MainLayout>
      <Box p={4}>
        <Box mb={4}>
          <InputGroup size={['sm', 'md']}>
            <Input
              focusBorderColor="#f9f9f9f9"
              borderRadius="0"
              placeholder="Search for doctors"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
            />
            <Button _hover={{bg: "orange.800"}} color='white' bg="#541e1b" colorScheme="teal" ml={2} onClick={() => navigate(`/doctors?query=${encodeURIComponent(searchQuery)}`)}>
              Search
            </Button>
          </InputGroup>
        </Box>

        {loading ? (
          <Spinner size="xl" />
        ) : (
          <Box display={['block', 'block', 'flex']} gap='4' alignItems='flex-start'>
            <Box w={['100%', '100%', "60%"]}>
              {currentDoctors.length > 0 ? (
                <List spacing={3}>
                  {currentDoctors.map((doctor) => (
                    <ListItem key={doctor.id} bg='red' my='3' display='flex' justifyContent='space-between' px={['3']}>
                      <Box display={['flex']} alignItems='center' gap='2'>
                        {doctor.imageUrl ? (
                          <Image boxSize={['150px']} borderRadius='50%' src={doctor.imageUrl} alt="Doctor Image" />
                        ) : (
                          <Avatar boxSize={['150px']} name={doctor.name} size="md" />
                        )}
                        <div className="">
                          <Text fontSize="lg">{doctor.name}</Text>
                          <Text fontSize="lg">{doctor.specialization}</Text>
                          <Text fontSize="lg">{doctor.workLocation}</Text>
                        </div>
                      </Box>
                      <Box onClick={() => makeAnAppointment(doctor.id)}>
                        <Text fontSize="lg" cursor="pointer">Make An Appointment</Text>
                      </Box>
                    </ListItem>
                  ))}
                </List>
              ) : (
                <Text>No doctors found for "{queryParam}".</Text>
              )}
            </Box>
            <AdvertComp />
          </Box>
        )}

        {/* Pagination */}
        {doctors.length > doctorsPerPage && (
          <Box mt={4} display="flex" justifyContent="center" alignItems="center">
            <Button
              onClick={handlePrevPage}
              disabled={currentPage === 1}
              colorScheme="teal"
              mr={2}
            >
              Previous
            </Button>
            {Array.from({ length: totalPages }, (_, index) => (
              <Button
                key={index}
                onClick={() => goToPage(index + 1)}
                variant={currentPage === index + 1 ? "solid" : "outline"}
                colorScheme="teal"
                mr={2}
              >
                {index + 1}
              </Button>
            ))}
            <Button
              onClick={handleNextPage}
              disabled={currentPage === totalPages}
              colorScheme="teal"
              ml={2}
            >
              Next
            </Button>
          </Box>
        )}
      </Box>
    </MainLayout>
  );
}

export default SearchDoctors;
